# Hydra Sidecar Makefile
# Build and version management for the sidecar

# Image settings
IMAGE_NAME ?= hydra-sidecar
IMAGE_TAG ?= latest
PLATFORMS ?= linux/amd64,linux/arm64
DISTROLESS_VARIANT ?= debug-nonroot

# Go container for running go commands without local Go installation
GO_IMAGE ?= golang:1.21-alpine

# Version file
VERSIONS_FILE := versions.yaml

.PHONY: build build-local build-hardened push clean \
        compute-versions validate-versions tidy swagger swagger-fmt help

##@ Build Targets

build: validate-versions ## Multi-arch build and push to registry
	docker buildx build \
		--platform $(PLATFORMS) \
		--build-arg DISTROLESS_VARIANT=$(DISTROLESS_VARIANT) \
		-t $(IMAGE_NAME):$(IMAGE_TAG) \
		--push .

build-local: validate-versions tidy ## Local build for current arch (for kind)
	docker build \
		--build-arg DISTROLESS_VARIANT=$(DISTROLESS_VARIANT) \
		-t $(IMAGE_NAME):$(IMAGE_TAG) .

build-hardened: validate-versions tidy ## Production build without shell
	docker buildx build \
		--platform $(PLATFORMS) \
		--build-arg DISTROLESS_VARIANT=nonroot \
		-t $(IMAGE_NAME):$(IMAGE_TAG) \
		--push .

clean: ## Remove built images
	docker rmi $(IMAGE_NAME):$(IMAGE_TAG) || true

##@ Go Module Management

tidy: ## Tidy go modules (runs in container, no local Go required)
	docker run --rm \
		-v "$$(pwd):/app" \
		-w /app \
		$(GO_IMAGE) \
		go mod tidy

##@ Documentation

swagger: ## Generate Swagger/OpenAPI docs (runs in container)
	docker run --rm \
		-v "$$(pwd):/app" \
		-w /app \
		$(GO_IMAGE) \
		sh -c "go install github.com/swaggo/swag/cmd/swag@latest && swag init -g main.go -o ./docs"

swagger-fmt: ## Format Swagger annotations
	docker run --rm \
		-v "$$(pwd):/app" \
		-w /app \
		$(GO_IMAGE) \
		sh -c "go install github.com/swaggo/swag/cmd/swag@latest && swag fmt"

##@ Version Management

compute-versions: ## Compute all versions from HYDRA_IMAGE_TAG and write to versions.yaml
	@if [ -z "$(HYDRA_IMAGE_TAG)" ]; then \
		echo "Error: HYDRA_IMAGE_TAG is required"; \
		echo "Usage: make compute-versions HYDRA_IMAGE_TAG=v25.4.0"; \
		exit 1; \
	fi
	@echo "Computing versions for Hydra image tag: $(HYDRA_IMAGE_TAG)"
	@# Get latest v2.x Go module version from GitHub tags
	@GO_MODULE=$$(curl -s "https://api.github.com/repos/ory/hydra/tags" | \
		grep -o '"name": "v2\.[^"]*"' | head -1 | cut -d'"' -f4); \
	if [ -z "$$GO_MODULE" ]; then \
		echo "Warning: Could not fetch Go module version, using default"; \
		GO_MODULE="v2.2.0"; \
	fi; \
	# Get Helm chart version from artifact hub or default
	HELM_CHART=$$(curl -s "https://artifacthub.io/api/v1/packages/helm/ory/hydra" | \
		grep -o '"version":"[^"]*"' | head -1 | cut -d'"' -f4 2>/dev/null || echo "0.52.0"); \
	if [ -z "$$HELM_CHART" ]; then \
		HELM_CHART="0.52.0"; \
	fi; \
	# Write versions.yaml
	echo "# Auto-generated by 'make compute-versions HYDRA_IMAGE_TAG=$(HYDRA_IMAGE_TAG)'" > $(VERSIONS_FILE); \
	echo "# Do not edit manually - run 'make compute-versions' to update" >> $(VERSIONS_FILE); \
	echo "" >> $(VERSIONS_FILE); \
	echo "hydra:" >> $(VERSIONS_FILE); \
	echo "  image_tag: \"$(HYDRA_IMAGE_TAG)\"" >> $(VERSIONS_FILE); \
	echo "  go_module: \"$$GO_MODULE\"" >> $(VERSIONS_FILE); \
	echo "  helm_chart: \"$$HELM_CHART\"" >> $(VERSIONS_FILE); \
	echo "" >> $(VERSIONS_FILE); \
	echo "computed_at: \"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> $(VERSIONS_FILE); \
	echo ""; \
	echo "Written $(VERSIONS_FILE):"; \
	cat $(VERSIONS_FILE)

validate-versions: ## Validate versions.yaml exists and has required fields
	@if [ ! -f "$(VERSIONS_FILE)" ]; then \
		echo "Warning: $(VERSIONS_FILE) not found, creating default..."; \
		echo "# Default versions - run 'make compute-versions HYDRA_IMAGE_TAG=<tag>' to update" > $(VERSIONS_FILE); \
		echo "" >> $(VERSIONS_FILE); \
		echo "hydra:" >> $(VERSIONS_FILE); \
		echo "  image_tag: \"v25.4.0\"" >> $(VERSIONS_FILE); \
		echo "  go_module: \"v2.2.0\"" >> $(VERSIONS_FILE); \
		echo "  helm_chart: \"0.52.0\"" >> $(VERSIONS_FILE); \
		echo "" >> $(VERSIONS_FILE); \
		echo "computed_at: \"$$(date -u +%Y-%m-%dT%H:%M:%SZ)\"" >> $(VERSIONS_FILE); \
	fi
	@# Check required fields exist
	@if ! grep -q "image_tag:" $(VERSIONS_FILE); then \
		echo "Error: $(VERSIONS_FILE) missing 'image_tag'"; \
		exit 1; \
	fi
	@if ! grep -q "go_module:" $(VERSIONS_FILE); then \
		echo "Error: $(VERSIONS_FILE) missing 'go_module'"; \
		exit 1; \
	fi
	@if ! grep -q "helm_chart:" $(VERSIONS_FILE); then \
		echo "Error: $(VERSIONS_FILE) missing 'helm_chart'"; \
		exit 1; \
	fi
	@echo "$(VERSIONS_FILE) is valid"

##@ Utilities

help: ## Show this help
	@awk 'BEGIN {FS = ":.*##"; printf "\nUsage:\n  make \033[36m<target>\033[0m\n"} /^[a-zA-Z_-]+:.*?##/ { printf "  \033[36m%-20s\033[0m %s\n", $$1, $$2 } /^##@/ { printf "\n\033[1m%s\033[0m\n", substr($$0, 5) } ' $(MAKEFILE_LIST)

.DEFAULT_GOAL := help
