apiVersion: gateway.envoyproxy.io/v1alpha1
kind: SecurityPolicy
metadata:
  name: jwt-auth
  namespace: default
  annotations:
    description: "JWT authentication via Ory Hydra with org_id extraction for rate limiting"
spec:
  targetRefs:
  # Only apply JWT auth to go-rest-route (apitest.local)
  # httpbin.local remains unauthenticated
  - group: gateway.networking.k8s.io
    kind: HTTPRoute
    name: go-rest-route
  jwt:
    providers:
    - name: hydra
      issuer: "http://hydra.local/auth"
      remoteJWKS:
        uri: http://hydra-public.hydra.svc.cluster.local:4444/.well-known/jwks.json
        cacheDuration: 60s  # Reduced from 300s default to minimize stale cache window
        backendRefs:
        - name: hydra-public
          namespace: hydra
          port: 4444
      claimToHeaders:
      # Extract org_id from token hook (ext namespace) for rate limiting
      # Multiple clients can share the same org_id for shared quotas
      - claim: ext.org_id
        header: x-org-id
      # Extract client_id for per-service tracking/logging
      - claim: client_id
        header: x-client-id
      # Extract tier for potential tiered rate limiting
      - claim: ext.tier
        header: x-tier
      # Extract subject for logging/debugging
      - claim: sub
        header: x-subject
