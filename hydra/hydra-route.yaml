# HTTPRoute to expose Hydra endpoints under /auth via APISIX Gateway
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: hydra-route
  namespace: hydra
  labels:
    app: hydra
  annotations:
    description: "Exposes Hydra OAuth2/OIDC endpoints under /auth path"
spec:
  parentRefs:
    - name: apisix-gateway
      namespace: apisix
  rules:
    # /auth/.well-known/* -> Hydra /.well-known/*
    - matches:
        - path:
            type: PathPrefix
            value: /auth/.well-known
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /.well-known
      backendRefs:
        - name: hydra-public
          namespace: hydra
          port: 4444
    # /auth/oauth2/* -> Hydra /oauth2/*
    - matches:
        - path:
            type: PathPrefix
            value: /auth/oauth2
      filters:
        - type: URLRewrite
          urlRewrite:
            path:
              type: ReplacePrefixMatch
              replacePrefixMatch: /oauth2
      backendRefs:
        - name: hydra-public
          namespace: hydra
          port: 4444
