apiVersion: apisix.apache.org/v2
kind: ApisixPluginConfig
metadata:
  name: go-rest-oidc
  namespace: default
spec:
  plugins:
  - name: openid-connect
    enable: true
    config:
      # Ory Hydra OIDC discovery endpoint
      discovery: http://hydra-public.hydra.svc.cluster.local:4444/.well-known/openid-configuration
      client_id: go-rest
      client_secret: go-rest-secret
      scope: "read write"
      bearer_only: true
      introspection_endpoint_auth_method: client_secret_post
      token_endpoint_auth_method: client_secret_post
      set_id_token_header: false
      set_userinfo_header: false
      # For M2M client_credentials, use client_id as consumer identity
      consumer_by:
      - client_id
      - sub
  - name: limit-req
    enable: true
    config:
      rate: 10
      burst: 5
      key_type: var
      key: consumer_name
      rejected_code: 429
      rejected_msg: "Rate limited (identity)."
  - name: limit-count
    enable: true
    config:
      count: 240
      time_window: 60
      key_type: var
      key: remote_addr
      rejected_code: 429
      rejected_msg: "Quota exceeded (source IP)."
